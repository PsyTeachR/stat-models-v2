{
  "hash": "c5e3134ddc115a8936a9633702eb6885",
  "result": {
    "engine": "knitr",
    "markdown": "# Multiple regression\n\n## Correlation matrices\n\nYou may be familiar with the concept of a **correlation matrix** from reading papers in psychology. Correlation matrices are a common way of summarizing relationships between multiple measurements taken from the same individual.\n\nLet's say you've measured psychological well-being using multiple scales. One question is the extent to which these scales are measuring the same thing. Often you will look at a correlation matrix to explore all the pairwise relationships between measures.\n\n\nIf you have $n$ measures, how many pairwise correlations can you compute? You can figure this out either by the formula in the info box below, or more easily you can computed it directly through the `choose(n, 2)` function in R. For instance, to get the number of possible pairwise correlations between 6 measures, you'd type `choose(6, 2)`, which tells you that you have 15 combinations.\n\n::: {.callout-note}\nFor any $n$ measures, you can calculate $\\frac{n!}{2(n - 2)!}$ pairwise correlations between measures. The $!$ symbol is called the **factorial** operator, defined as the product of all numbers from 1 to $n$. So, if you have six measurements, you have\n\n$$\n\\frac{6!}{2(6-2)!} = \\frac{1 \\times 2 \\times 3 \\times 4 \\times 5 \\times 6}{2\\left(1 \\times 2 \\times 3 \\times 4\\right)} = \\frac{720}{2(24)} = 15\n$$\n:::\n\nYou can create a correlation matrix in R using `base::cor()` or `corrr::correlate()`. We prefer the latter function because `cor()` requires that your data is stored in a matrix, whereas most of the data we will be working with is tabular data stored in a data frame. The `corrr::correlate()` function takes a data frame as the first argument, and provides \"tidy\" output, so it integrates better with tidyverse functions and pipes (`|>`).\n\nLet's create a correlation matrix to see how it works. Start by loading in the packages we will need.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\")\nlibrary(\"corrr\")  # install.packages(\"corrr\") in console if missing\n```\n:::\n\n\n\n\nWe will use the `starwars` dataset, which is a built-in dataset that becomes available after you load the tidyverse package. This dataset has information about various characters that have appeared in the Star Wars film series. Let's look at the correlation between \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  select(height, mass, birth_year) |>\n  correlate()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n• Method: 'pearson'\n• Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 4\n  term       height   mass birth_year\n  <chr>       <dbl>  <dbl>      <dbl>\n1 height     NA      0.131     -0.404\n2 mass        0.131 NA          0.478\n3 birth_year -0.404  0.478     NA    \n```\n\n\n:::\n:::\n\n\n\n\nYou can look up any bivariate correlation at the intersection of any given row or column. So the correlation between `height` and `mass` is .134, which you can find in row 1, column 2 or row 2, column 1; the values are the same. Note that there are only `choose(3, 2)` = 3 unique bivariate relationships, but each appears twice in the table. We might want to show only the unique pairs. We can do this by appending `corrr::shave()` to our pipeline.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  select(height, mass, birth_year) |>\n  correlate() |>\n  shave()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n• Method: 'pearson'\n• Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 4\n  term       height   mass birth_year\n  <chr>       <dbl>  <dbl>      <dbl>\n1 height     NA     NA             NA\n2 mass        0.131 NA             NA\n3 birth_year -0.404  0.478         NA\n```\n\n\n:::\n:::\n\n\n\n\nNow we've only got the lower triangle of the correlation matrix, but the `NA` values are ugly and so are the leading zeroes. The **`corrr`** package also provides the `fashion()` function that cleans things up (see `?corrr::fashion` for more options).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  select(height, mass, birth_year) |>\n  correlate() |>\n  shave() |>\n  fashion()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n• Method: 'pearson'\n• Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        term height mass birth_year\n1     height                       \n2       mass    .13                \n3 birth_year   -.40  .48           \n```\n\n\n:::\n:::\n\n\n\n\nCorrelations only provide a good description of the relationship if the relationship is (roughly) linear and there aren't severe outliers that are wielding too strong of an influence on the results. So it is always a good idea to visualize the correlations as well as to quantify them.  The `base::pairs()` function does this. The first argument to `pairs()` is simply of the form `~ v1 + v2 + v3 + ... + vn` where `v1`, `v2`, etc. are the names of the variables you want to correlate.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npairs(~ height + mass + birth_year, starwars)\n```\n\n::: {.cell-output-display}\n![Pairwise correlations for the starwars dataset](multiple-reg_files/figure-html/fig-pairs-1.png){#fig-pairs width=576}\n:::\n:::\n\n\n\n\nWe can see that there is a big outlier influencing our data; in particular, there is a creature with a mass greater than 1200kg! Let's find out who this is and eliminate them from the dataset.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  filter(mass > 1200) |>\n  select(name, mass, height, birth_year)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  name                   mass height birth_year\n  <chr>                 <dbl>  <int>      <dbl>\n1 Jabba Desilijic Tiure  1358    175        600\n```\n\n\n:::\n:::\n\n\n\n\nOK, let's see how the data look without this massive creature.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars2 <- starwars |>\n  filter(name != \"Jabba Desilijic Tiure\")\n\npairs(~height + mass + birth_year, starwars2)\n```\n\n::: {.cell-output-display}\n![Pairwise correlations for the starwars dataset after removing outlying value on `mass`.](multiple-reg_files/figure-html/fig-massive-creature-1.png){#fig-massive-creature width=672}\n:::\n:::\n\n\n\n\nBetter, but there's a creature with an outlying birth year that we might want to get rid of.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars2 |>\n  filter(birth_year > 800) |>\n  select(name, height, mass, birth_year)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 4\n  name  height  mass birth_year\n  <chr>  <int> <dbl>      <dbl>\n1 Yoda      66    17        896\n```\n\n\n:::\n:::\n\n\n\n\nIt's Yoda. He's as old as the universe. Let's drop him and see how the plots look.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars3 <- starwars2 |>\n  filter(name != \"Yoda\")\n\npairs(~height + mass + birth_year, starwars3)\n```\n\n::: {.cell-output-display}\n![Pairwise correlations for the starwars dataset after removing outlying values on `mass` and `birth_year`.](multiple-reg_files/figure-html/fig-bye-yoda-1.png){#fig-bye-yoda width=576}\n:::\n:::\n\n\n\n\nThat looks much better. Let's see how that changes our correlation matrix.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars3 |>\n  select(height, mass, birth_year) |>\n  correlate() |>\n  shave() |>\n  fashion()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n• Method: 'pearson'\n• Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        term height mass birth_year\n1     height                       \n2       mass    .73                \n3 birth_year    .44  .24           \n```\n\n\n:::\n:::\n\n\n\n\nNote that these values are quite different from the ones we started with.\n\nSometimes it's not a great idea to remove outliers. Another approach to dealing with outliers is to use a robust method. The default correlation coefficient that is computed by `corrr::correlate()` is the Pearson product-moment correlation coefficient. You can also compute the Spearman correlation coefficient by changing the `method()` argument to `correlate()`. This replaces the values with ranks before computing the correlation, so that outliers will still be included, but will have dramatically less influence.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  select(height, mass, birth_year) |>\n  correlate(method = \"spearman\") |>\n  shave() |>\n  fashion()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nCorrelation computed with\n• Method: 'spearman'\n• Missing treated using: 'pairwise.complete.obs'\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        term height mass birth_year\n1     height                       \n2       mass    .72                \n3 birth_year    .15  .15           \n```\n\n\n:::\n:::\n\n\n\n\nIncidentally, if you are generating a report from R Markdown and want your tables to be nicely formatted you can use `knitr::kable()`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarwars |>\n  select(height, mass, birth_year) |>\n  correlate(method = \"spearman\") |>\n  shave() |>\n  fashion() |>\n  knitr::kable()\n```\n\n::: {.cell-output-display}\n\n\n|term       |height |mass |birth_year |\n|:----------|:------|:----|:----------|\n|height     |       |     |           |\n|mass       |.72    |     |           |\n|birth_year |.15    |.15  |           |\n\n\n:::\n:::\n\n\n\n## Exercises\n\n\n\n\n::: {.cell}\n<iframe src=\"https://talklab.psy.gla.ac.uk/app/covariance-site/?showcase=0\" width=\"530px\" height=\"480px\" data-external=\"1\"></iframe>\n:::\n",
    "supporting": [
      "multiple-reg_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}